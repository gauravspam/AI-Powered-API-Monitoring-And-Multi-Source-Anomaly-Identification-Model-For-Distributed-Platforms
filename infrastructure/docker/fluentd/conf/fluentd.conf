# Fluentd Configuration for API Monitoring Platform
# This configuration receives logs from Fluent Bit agents and forwards to OpenSearch

<source>
  @type forward
  @id input_forward
  port 24224
  bind 0.0.0.0
</source>

# HTTP input for direct log ingestion
<source>
  @type http
  @id input_http
  port 9880
  bind 0.0.0.0
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    keep_time_key true
  </parse>
</source>

# Parse incoming logs
<filter **>
  @type record_transformer
  <record>
    hostname ${hostname}
    tag ${tag}
    received_at ${Time.now.utc.iso8601}
  </record>
</filter>

# Route logs based on tag
<match api-logs.**>
  @type copy
  <store>
    @type opensearch
    @id output_opensearch_api_logs
    host opensearch
    port 9200
    scheme https
    user admin
    password Str0ng@ApiMon#2025
    ssl_verify false
    logstash_format true
    logstash_prefix api-logs
    logstash_dateformat %Y.%m.%d
    include_tag_key true
    tag_key @log_name
    type_name _doc
    <buffer>
      @type file
      path /var/log/fluentd-buffer/opensearch
      flush_interval 10s
      retry_type exponential_backoff
      retry_wait 1s
      retry_max_interval 60s
      retry_timeout 60m
      overflow_action block
    </buffer>
  </store>
  <store>
    @type postgres
    @id output_postgres_metadata
    host postgres
    port 5432
    database api_monitoring
    username api_monitor
    password api_monitor_pass
    key_names service,level,message,timestamp
    sql INSERT INTO log_metadata (service, level, message, timestamp, created_at) VALUES ($1, $2, $3, $4, NOW())
    <buffer>
      @type file
      path /var/log/fluentd-buffer/postgres
      flush_interval 30s
      retry_type exponential_backoff
      retry_wait 1s
      retry_max_interval 60s
      retry_timeout 60m
    </buffer>
  </store>
</match>

# Route metrics
<match metrics.**>
  @type opensearch
  @id output_opensearch_metrics
  host opensearch
  port 9200
  scheme https
  user admin
  password Str0ng@ApiMon#2025
  ssl_verify false
  logstash_format true
  logstash_prefix metrics
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  type_name _doc
  <buffer>
    @type file
    path /var/log/fluentd-buffer/metrics
    flush_interval 10s
    retry_type exponential_backoff
    retry_wait 1s
    retry_max_interval 60s
    retry_timeout 60m
    overflow_action block
  </buffer>
</match>

# Default match - forward everything else to OpenSearch
<match **>
  @type opensearch
  @id output_opensearch_default
  host opensearch
  port 9200
  scheme https
  user admin
  password Str0ng@ApiMon#2025
  ssl_verify false
  logstash_format true
  logstash_prefix fluentd
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  type_name _doc
  <buffer>
    @type file
    path /var/log/fluentd-buffer/default
    flush_interval 10s
    retry_type exponential_backoff
    retry_wait 1s
    retry_max_interval 60s
    retry_timeout 60m
    overflow_action block
  </buffer>
</match>

